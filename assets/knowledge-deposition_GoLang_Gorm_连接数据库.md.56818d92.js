import{_ as s,c as n,o as a,a as l}from"./app.aaa56bb0.js";const i=JSON.parse('{"title":"连接数据库","description":"","frontmatter":{"layout":"doc"},"headers":[{"level":2,"title":"连接Mysql数据库","slug":"连接mysql数据库","link":"#连接mysql数据库","children":[{"level":3,"title":"项目初始化","slug":"项目初始化","link":"#项目初始化","children":[]},{"level":3,"title":"下载依赖","slug":"下载依赖","link":"#下载依赖","children":[]},{"level":3,"title":"连接数据库","slug":"连接数据库-1","link":"#连接数据库-1","children":[]}]},{"level":2,"title":"高级配置","slug":"高级配置","link":"#高级配置","children":[{"level":3,"title":"日志配置","slug":"日志配置","link":"#日志配置","children":[]}]}],"relativePath":"knowledge-deposition/GoLang/Gorm/连接数据库.md"}'),o={name:"knowledge-deposition/GoLang/Gorm/连接数据库.md"},p=l(`<h1 id="连接数据库" tabindex="-1">连接数据库 <a class="header-anchor" href="#连接数据库" aria-hidden="true">#</a></h1><ul><li><code>GORM</code>官方支持的数据库类型有：<code>MySQL</code>、<code>PostgreSQL</code>、<code>SQlite</code>、<code>SQL Server</code></li></ul><h2 id="连接mysql数据库" tabindex="-1">连接<code>Mysql</code>数据库 <a class="header-anchor" href="#连接mysql数据库" aria-hidden="true">#</a></h2><h3 id="项目初始化" tabindex="-1">项目初始化 <a class="header-anchor" href="#项目初始化" aria-hidden="true">#</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gorm-related</span></span>
<span class="line"></span></code></pre></div><ul><li>项目目录</li></ul><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#82AAFF;">.</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">└──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">db.yaml</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">go.mod</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">go.sum</span></span>
<span class="line"><span style="color:#FFCB6B;">└──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main.go</span></span>
<span class="line"></span></code></pre></div><ul><li><code>config/db.yaml</code>配置</li></ul><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#F07178;">mysql</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">db1</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">study_student</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">127.0.0.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">dbName</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lyb</span></span>
<span class="line"></span></code></pre></div><h3 id="下载依赖" tabindex="-1">下载依赖 <a class="header-anchor" href="#下载依赖" aria-hidden="true">#</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 连接数据库使用</span></span>
<span class="line"><span style="color:#FFCB6B;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-u</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gorm.io/gorm</span></span>
<span class="line"><span style="color:#FFCB6B;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-u</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gorm.io/driver/mysql</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 读取mysql yaml配置</span></span>
<span class="line"><span style="color:#FFCB6B;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-u</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">github.com/spf13/viper</span></span>
<span class="line"></span></code></pre></div><h3 id="连接数据库-1" tabindex="-1">连接数据库 <a class="header-anchor" href="#连接数据库-1" aria-hidden="true">#</a></h3><ul><li><strong>拆分为下面三步:</strong></li></ul><h4 id="读取yaml的mysql配置" tabindex="-1">读取<code>yaml</code>的<code>mysql</code>配置 <a class="header-anchor" href="#读取yaml的mysql配置" aria-hidden="true">#</a></h4><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DatabaseConfig</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	Username </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">	Password </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">	Host     </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">	Port     </span><span style="color:#C792EA;">int</span></span>
<span class="line"><span style="color:#A6ACCD;">	DBName   </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 获取数据库配置</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loadDbConfig</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">configFile </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">DatabaseConfig</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	viper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SetConfigFile</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">configFile</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> viper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReadInConfig</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Errorf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">failed to read config file: %w</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">var</span><span style="color:#A6ACCD;"> config DatabaseConfig</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> viper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">UnmarshalKey</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mysql.db1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Errorf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">failed to unmarshal config: %w</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="根据配置生成连接dsn-data-source-name" tabindex="-1">根据配置生成连接<code>DSN(Data Source Name)</code> <a class="header-anchor" href="#根据配置生成连接dsn-data-source-name" aria-hidden="true">#</a></h4><blockquote><p>Data Source Name 格式如下</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">username</span><span style="color:#89DDFF;">[:</span><span style="color:#A6ACCD;">password</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">@</span><span style="color:#89DDFF;">][</span><span style="color:#A6ACCD;">protocol</span><span style="color:#89DDFF;">[(</span><span style="color:#A6ACCD;">address</span><span style="color:#89DDFF;">)]]/</span><span style="color:#A6ACCD;">dbname</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">?param1</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">value1</span><span style="color:#89DDFF;">&amp;...&amp;</span><span style="color:#A6ACCD;">paramN</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">valueN</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre></div><blockquote><p>Data Source Name 一些例子</p></blockquote><div class="tip custom-block"><p class="custom-block-title">TIP</p><ul><li><p>要支持完整的<code>UTF-8</code>编码，需要将<code>charset=utf8</code>更改为<code>charset=utf8mb4</code></p></li><li><p><code>parseTime=true</code>支持把数据库<code>datetime</code>和<code>date</code>类型转换为<code>golang</code>的<code>time.Time</code>类型</p></li><li><p><code>loc=Local</code>使用系统本地时区</p></li><li><p><code>timeout</code> 数据库连接超时时间，例如<code>timeout=10s</code></p></li><li><p><code>readTimeout</code> 读超时时间，<code>0代表不限制</code></p></li><li><p><code>writeTimeout</code> 写超时时间，<code>0代表不限制</code></p></li></ul></div><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">//mysql dsn格式</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//涉及参数:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//username   数据库账号</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//password   数据库密码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//host       数据库连接地址，可以是Ip或者域名</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//port       数据库端口</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//Dbname     数据库名</span></span>
<span class="line"><span style="color:#A6ACCD;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">password@</span><span style="color:#82AAFF;">tcp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">port</span><span style="color:#89DDFF;">)/</span><span style="color:#A6ACCD;">Dbname?charset</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">parseTime</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">True</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">loc</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">Local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//填上参数后的例子</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//username = admin</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//password = 258369</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//host     = 127.0.0.1</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//port     = 1000</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//Dbname   = gorm</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//后面K/V键值对参数含义为：</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//  charset=utf8mb4 客户端字符集为utf8mb4(要支持完整的UTF-8编码，需要将charset=utf8更改为charset=utf8mb4</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//  parseTime=true 支持把数据库datetime和date类型转换为golang的time.Time类型</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//  loc=Local 使用系统本地时区</span></span>
<span class="line"><span style="color:#A6ACCD;">admin</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">258369</span><span style="color:#A6ACCD;">@</span><span style="color:#82AAFF;">tcp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">127.0.0.1</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">1000</span><span style="color:#89DDFF;">)/</span><span style="color:#A6ACCD;">gorm?charset</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">parseTime</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">True</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">loc</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">Local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//gorm 设置mysql连接超时参数</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//开发的时候经常需要设置数据库连接超时参数，gorm是通过dsn的timeout参数配置</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//例如，设置10秒后连接超时，timeout=10s</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//下面是完成的例子</span></span>
<span class="line"><span style="color:#A6ACCD;">admin</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">258369</span><span style="color:#A6ACCD;">@</span><span style="color:#82AAFF;">tcp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">127.0.0.1</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">1000</span><span style="color:#89DDFF;">)/</span><span style="color:#A6ACCD;">gorm?charset</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">parseTime</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">True</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">loc</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">Local</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">10s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//设置读写超时时间</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// readTimeout - 读超时时间，0代表不限制</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// writeTimeout - 写超时时间，0代表不限制</span></span>
<span class="line"><span style="color:#A6ACCD;">admin</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">258369</span><span style="color:#A6ACCD;">@</span><span style="color:#82AAFF;">tcp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">127.0.0.1</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">1000</span><span style="color:#89DDFF;">)/</span><span style="color:#A6ACCD;">gorm?charset</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">parseTime</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">True</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">loc</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">Local</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">10s</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">readTimeout</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">30s</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">writeTimeout</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">60s</span></span>
<span class="line"></span></code></pre></div><blockquote><p>代码</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 生产连接数据库链接</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">genDbUrl</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">config </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">DatabaseConfig</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sprintf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Username</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Password</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Host</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Port</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DBName</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="连接数据库-2" tabindex="-1">连接数据库 <a class="header-anchor" href="#连接数据库-2" aria-hidden="true">#</a></h4><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 连接数据库</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">connectToDb</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbUrl </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	db</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> gorm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Open</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Open</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbUrl</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">{})</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Errorf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">failed to connect to MySQL database: %w</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><ul><li><strong>完整代码</strong></li></ul><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">fmt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">log</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">github.com/spf13/viper</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">gorm.io/driver/mysql</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">gorm.io/gorm</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DatabaseConfig</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	Username </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">	Password </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">	Host     </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">	Port     </span><span style="color:#C792EA;">int</span></span>
<span class="line"><span style="color:#A6ACCD;">	DBName   </span><span style="color:#C792EA;">string</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 获取数据库配置</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loadDbConfig</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">configFile </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">DatabaseConfig</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	viper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SetConfigFile</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">configFile</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> viper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReadInConfig</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Errorf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">failed to read config file: %w</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">var</span><span style="color:#A6ACCD;"> config DatabaseConfig</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> viper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">UnmarshalKey</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mysql.db1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Errorf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">failed to unmarshal config: %w</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 生产连接数据库链接</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">genDbUrl</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">config </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">DatabaseConfig</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sprintf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Username</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Password</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Host</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Port</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DBName</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 连接数据库</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">connectToDb</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbUrl </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	db</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> gorm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Open</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Open</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbUrl</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">{})</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Errorf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">failed to connect to MySQL database: %w</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// 获取数据库配置</span></span>
<span class="line"><span style="color:#A6ACCD;">	dbConfig</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loadDbConfig</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">config/db.yaml</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Fatalf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Failed to load config: %v</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// 根据数据库配置获取url</span></span>
<span class="line"><span style="color:#A6ACCD;">	dbUrl </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">genDbUrl</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbConfig</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// 根据生产的url连接数据库</span></span>
<span class="line"><span style="color:#A6ACCD;">	db</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> connectErr </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">connectToDb</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbUrl</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> connectErr </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Fatalf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Failed to connect to MySQL database: %v</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> connectErr</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Successfully connected to MySQL database!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="高级配置" tabindex="-1">高级配置 <a class="header-anchor" href="#高级配置" aria-hidden="true">#</a></h2><h3 id="日志配置" tabindex="-1">日志配置 <a class="header-anchor" href="#日志配置" aria-hidden="true">#</a></h3><ul><li><p>日志级别有<code>Silent</code>、<code>Error</code>、<code>Warn</code>、<code>Info</code></p></li><li><p><code>Gorm</code>有一个<a href="https://github.com/go-gorm/gorm/blob/master/logger/logger.go" target="_blank" rel="noreferrer">默认 logger</a>实现，默认情况下，它会打印<code>慢SQL</code>和<code>错误</code></p></li><li><p>可以在<code>初始化</code>时自定义它，会改变<code>全局日志规则</code></p></li></ul><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">newLogger </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> logger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">os</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Stdout</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\\r\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">LstdFlags</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// io writer</span></span>
<span class="line"><span style="color:#A6ACCD;">  logger</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    SlowThreshold</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">              time</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Second</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// Slow SQL threshold 慢sql阀值</span></span>
<span class="line"><span style="color:#A6ACCD;">    LogLevel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">                   logger</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Info</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// Log level 日志级别</span></span>
<span class="line"><span style="color:#A6ACCD;">    IgnoreRecordNotFoundError</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// Ignore ErrRecordNotFound error for logger 忽略ErrRecordNotFound（记录未找到）错误</span></span>
<span class="line"><span style="color:#A6ACCD;">    ParameterizedQueries</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// Don&#39;t include params in the SQL log 不要在 SQL 日志中包含参数</span></span>
<span class="line"><span style="color:#A6ACCD;">    Colorful</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">                  </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// Disable color 关闭颜色</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">db</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> gorm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Open</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Open</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dbUrl</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Config</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  Logger</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> newLogger</span></span>
<span class="line"><span style="color:#89DDFF;">})</span></span>
<span class="line"></span></code></pre></div><ul><li>修改一个连续会话日志</li></ul><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// Continuous session mode</span></span>
<span class="line"><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Session</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">Logger</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> newLogger</span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">First</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Model</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Age</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">18</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ul><li><code>Debug</code>单个操作，将<code>当前操作</code>的<code>log</code>级别调整为<code>logger.Info</code></li></ul><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Debug</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">AutoMigrate</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">{})</span></span>
<span class="line"></span></code></pre></div><p><code>Debug</code>方法原理如下</p><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// Debug start debug mode</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">db </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Debug</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	tx </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getInstance</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Session</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		Logger</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Logger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">LogMode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">logger</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Info</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div>`,37),e=[p];function t(c,r,D,y,F,C){return a(),n("div",null,e)}const d=s(o,[["render",t]]);export{i as __pageData,d as default};
