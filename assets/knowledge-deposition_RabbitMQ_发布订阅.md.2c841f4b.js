import{_ as s,c as n,o as a,e as l}from"./app.4ea82cce.js";const i=JSON.parse('{"title":"发布订阅","description":"","frontmatter":{"layout":"doc"},"headers":[{"level":2,"title":"交换机","slug":"交换机","link":"#交换机","children":[{"level":3,"title":"Direct(直连模式)","slug":"direct-直连模式","link":"#direct-直连模式","children":[]},{"level":3,"title":"Topic(主题模式)","slug":"topic-主题模式","link":"#topic-主题模式","children":[]},{"level":3,"title":"Headers(头部模式)","slug":"headers-头部模式","link":"#headers-头部模式","children":[]},{"level":3,"title":"Fanout(广播模式)","slug":"fanout-广播模式","link":"#fanout-广播模式","children":[]}]},{"level":2,"title":"一个简单案例","slug":"一个简单案例","link":"#一个简单案例","children":[]}],"relativePath":"knowledge-deposition/RabbitMQ/发布订阅.md"}'),p={name:"knowledge-deposition/RabbitMQ/发布订阅.md"},o=l(`<h1 id="发布订阅" tabindex="-1">发布订阅 <a class="header-anchor" href="#发布订阅" aria-hidden="true">#</a></h1><blockquote><p>之前的代码实现的都是<code>一对一</code>的模式，也就是<code>一个任务分配给一个消费者去消费</code>，但是其实也可以实现<code>一个任务分配给多个消费者</code></p></blockquote><blockquote><p>可以使用<code>发布/订阅</code>模式来实现，这种模式下，要使用到<code>交换机(Exchange)</code></p></blockquote><h2 id="交换机" tabindex="-1">交换机 <a class="header-anchor" href="#交换机" aria-hidden="true">#</a></h2><blockquote><p><code>交换机(Exchange)</code>的作用从<code>Producer</code>处接收<code>消息(Message)</code>，然后将消息发送到<code>队列(Queues)</code>中</p></blockquote><blockquote><p><code>交换机(Exchange)</code>必须明确自己如何去处理消息，这个规则取决于<code>交换机的类型</code></p></blockquote><blockquote><p><code>交换机(Exchange)</code>有这几种类型：<code>Topic</code>、<code>Direct</code>、<code>Headers</code>、<code>Fanout</code></p></blockquote><blockquote><p>之前的代码中都没有用到<code>交换机(Exchange)</code>，都是直接声明一个<code>具名队列</code></p></blockquote><blockquote><p>如下：函数<code>ch.PublishWithContext</code>中<code>exchange name</code>是空字符串，这时会使用一个默认的交换机</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 3. declare a queue，it will only be created if it doesn&#39;t exist already</span></span>
<span class="line"><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">second_queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">//delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">//exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// publish message</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    withTimeoutCtx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">//immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h3 id="direct-直连模式" tabindex="-1"><code>Direct</code>(直连模式) <a class="header-anchor" href="#direct-直连模式" aria-hidden="true">#</a></h3><blockquote><p><code>交换机(Exchange)</code>将消息发送到某个匹配的<code>队列中</code>，匹配规则是：这个<code>队列的binding key(其实也可以叫routing key)</code>要和<code>消息的routing key</code>一致</p></blockquote><div class="tip custom-block"><p class="custom-block-title">TIP</p><ul><li><p>队列的<code>binding key</code>在调用<code>ch.QueueBind</code>方法时指定</p></li><li><p>消息的<code>routing key</code>在调用<code>ch.PublishWithContext</code>方法中指定</p></li></ul></div><blockquote><p>适用于明确指定的路由，例如，处理特定类型的任务，简单示例代码如下：</p></blockquote><blockquote><p><code>producer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directLogs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">direct</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    ctx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// context</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directLogs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directRoutingKey</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p><code>consumer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directLogs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">direct</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directQueue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 将交换机和队列进行绑定</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueBind</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    q</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directRoutingKey</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// binding key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">directLogs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"></span></code></pre></div><h3 id="topic-主题模式" tabindex="-1"><code>Topic</code>(主题模式) <a class="header-anchor" href="#topic-主题模式" aria-hidden="true">#</a></h3><blockquote><p>将接收到的消息放到和交换机指定的<code>routing key</code>匹配的<code>队列</code>里面</p><p>额外增加使用<code>*</code>(匹配<code>一个单词</code>)或使用<code>#</code>(匹配<code>多个单词</code>)</p></blockquote><blockquote><p>比起<code>Direct</code>模式，在验证<code>routing key</code>的时候，多了匹配规则</p></blockquote><blockquote><p><code>producer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topic</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    ctx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// context</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicRoutingKey.abc</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p><code>consumer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topic</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicQueue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 将交换机和队列进行绑定</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueBind</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    q</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicRoutingKey.*</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key 多了一个匹配规则</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topicTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"></span></code></pre></div><h3 id="headers-头部模式" tabindex="-1"><code>Headers</code>(头部模式) <a class="header-anchor" href="#headers-头部模式" aria-hidden="true">#</a></h3><blockquote><p>使用<code>消息头属性(headers)</code>来路由消息，而<code>不是路由键</code>，可以匹配多个头</p><p>使用<code>Headers</code>模式，不用指定<code>routing key</code></p><p><code>amqp.Table</code>的数据类型是<code>Map</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Table</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">map[</span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">]interface{}</span></span>
<span class="line"></span></code></pre></div><blockquote><p><code>producer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headersTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headers</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    ctx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// context</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headersTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key Headers模式下不用指定routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        Headers</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Table</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// Headers模式下，会检查该字段，要传该字段</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">format</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pdf</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">report</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p><code>consumer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headersTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headers</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headersQueue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 将交换机和队列进行绑定</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueBind</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    q</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">headersTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Table</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 此处要和上面发送时保持一致</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">format</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pdf</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">report</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"></span></code></pre></div><h3 id="fanout-广播模式" tabindex="-1"><code>Fanout</code>(广播模式) <a class="header-anchor" href="#fanout-广播模式" aria-hidden="true">#</a></h3><blockquote><p>把消息放入<code>交换机所有的队列</code>，实现广播功能</p><p><code>Fanout</code>模式会忽略<code>routing key</code></p></blockquote><blockquote><p><code>producer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanoutTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    ctx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// context</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanoutTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key Fanout 模式下不用指定routing key，会忽略该字段</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p><code>consumer.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanoutTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// exchange type</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// auto-deleted</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanoutQueue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 将交换机和队列进行绑定</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueBind</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    q</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanoutTask</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxx 其他代码</span></span>
<span class="line"></span></code></pre></div><h2 id="一个简单案例" tabindex="-1">一个简单案例 <a class="header-anchor" href="#一个简单案例" aria-hidden="true">#</a></h2><blockquote><p>生产者生产出一些日志消息，所有的消费者接收消息并打印出来，这种场景可以使用<code>Fanout(广播模式)</code></p></blockquote><blockquote><p>完整代码如下：</p></blockquote><blockquote><p>生产方<code>emit.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">context</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">fmt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	amqp </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">github.com/rabbitmq/amqp091-go</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">go-rabbitmq/shared</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">strings</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">time</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">startUpAndSend</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// create connection</span></span>
<span class="line"><span style="color:#A6ACCD;">	conn</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dial</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">amqp://guest:guest@localhost:5672</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">create connection error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">defer</span><span style="color:#A6ACCD;"> conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// create channel</span></span>
<span class="line"><span style="color:#A6ACCD;">	ch</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Channel</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">create channel error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">defer</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">logsExchange</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange type =&gt; headers, topic, direct, fanout</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// auto-delete</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// args</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">declare exchange error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// publish message</span></span>
<span class="line"><span style="color:#A6ACCD;">	ctx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> cancelFunc </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithTimeout</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Background</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Second</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">defer</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">cancelFunc</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">i </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			messageBody </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sprintf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">我是第[%d]条消息%s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> strings</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Repeat</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">			err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">				ctx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">logsExchange</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">				amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">					DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">					ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">					Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">publish message error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> [x] Sent %s</span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> messageBody</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">}(</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> time</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Second</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">startUpAndSend</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>消费方<code>receive.go</code></p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">fmt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	amqp </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">github.com/rabbitmq/amqp091-go</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">go-rabbitmq/shared</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">startUpAndReceive</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// create connection</span></span>
<span class="line"><span style="color:#A6ACCD;">	conn</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dial</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">amqp://guest:guest@localhost:5672</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">create connection error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">defer</span><span style="color:#A6ACCD;"> conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// create channel</span></span>
<span class="line"><span style="color:#A6ACCD;">	ch</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Channel</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">create channel error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">defer</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// declare exchange</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ExchangeDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">logsExchange</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exchange type =&gt; headers, topic, direct, fanout</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// auto-delete</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// internal</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// args</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">declare exchange error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// declare unnamed queue</span></span>
<span class="line"><span style="color:#A6ACCD;">	queue</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">declare queue error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// bind exchange and queue</span></span>
<span class="line"><span style="color:#A6ACCD;">	err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueBind</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">logsExchange</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">bind exchange and queue error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// consume message</span></span>
<span class="line"><span style="color:#A6ACCD;">	lockChan </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">make</span><span style="color:#89DDFF;">(chan</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">struct{})</span></span>
<span class="line"><span style="color:#A6ACCD;">	messages</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Consume</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">consume message error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">range</span><span style="color:#A6ACCD;"> messages </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Received a message: %s</span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Body</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}()</span></span>
<span class="line"><span style="color:#A6ACCD;">	fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">[*] Waiting for messages. To exit press CTRL+C</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;-</span><span style="color:#A6ACCD;">lockChan</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">startUpAndReceive</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>上面代码，在多个窗口分别运行<code>receive.go</code>中，然后运行<code>emit.go</code>，每个窗口都会接收到发送的数据</p></blockquote>`,46),e=[o];function t(c,D,r,y,F,C){return a(),n("div",null,e)}const u=s(p,[["render",t]]);export{i as __pageData,u as default};
