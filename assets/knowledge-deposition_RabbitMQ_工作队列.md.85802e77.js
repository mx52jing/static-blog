import{_ as s,c as n,o as a,e as l}from"./app.fa87702c.js";const i=JSON.parse('{"title":"工作队列","description":"","frontmatter":{"layout":"doc"},"headers":[{"level":2,"title":"循环分发消息","slug":"循环分发消息","link":"#循环分发消息","children":[]},{"level":2,"title":"消息确认","slug":"消息确认","link":"#消息确认","children":[]},{"level":2,"title":"消息持久化","slug":"消息持久化","link":"#消息持久化","children":[]}],"relativePath":"knowledge-deposition/RabbitMQ/工作队列.md"}'),o={name:"knowledge-deposition/RabbitMQ/工作队列.md"},p=l(`<h1 id="工作队列" tabindex="-1">工作队列 <a class="header-anchor" href="#工作队列" aria-hidden="true">#</a></h1><h2 id="循环分发消息" tabindex="-1">循环分发消息 <a class="header-anchor" href="#循环分发消息" aria-hidden="true">#</a></h2><blockquote><p>默认情况下，<code>RabbitMQ</code>将按顺序将每条消息发送给下一个消费者，每个<code>Consumer</code>将收到相同数量的消息，这种分发消息的方式称为<code>循环轮询</code></p><p>我们可以同时开启多个协程去消费消息来测试这一特性，消费消息的我们称之为<code>worker</code></p></blockquote><blockquote><p>写一个通用的接收消息的通用函数<code>consumeMessage</code>(worker.go)，然后开启<code>3</code>个协程去消费消息</p><p>可以看到，每个message被消费后，会等待一段时间，才能去消费下一个消息(消息文案中包含几个<code>.</code>，就等待<code>10-.的个数</code>秒)</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">consumeMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ch</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> queue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">consumeMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Channel</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> queueName </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serialNumber </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// 4、consume message</span></span>
<span class="line"><span style="color:#A6ACCD;">	message</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Consume</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">		queueName</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// consumer</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">// auto-ack</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// no-local</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// args</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">consume queue message error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">range</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">【NO %d】 Received a message: %s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serialNumber</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Body</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		dotCount </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> bytes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Count</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Body</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">		duration </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Duration</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> dotCount</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sleep</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">duration </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> time</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Second</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Done </span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>而在生产消息时(task.go)，一次性发送多条</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    messageBody </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sprintf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">我是第[%d]条消息%s </span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> strings</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Repeat</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">        withTimeoutCtx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">        queue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">//immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">        amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">            ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Publish message error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> [x] Sent %s</span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> messageBody</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>先运行消费者代码<code>worker.go</code>，然后执行生产者代码<code>task.go</code>，打印如下:</p></blockquote><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># workQueues/task.go 打印</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">]条消息.</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">]条消息..</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">]条消息...</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">]条消息....</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">]条消息.....</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">]条消息......</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">7</span><span style="color:#C3E88D;">]条消息.......</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">8</span><span style="color:#C3E88D;">]条消息........</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">9</span><span style="color:#C3E88D;">]条消息.........</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">10</span><span style="color:#C3E88D;">]条消息..........</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># go run workQueues/worker.go 打印</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">]条消息...,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">7s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">]条消息.,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">9s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">]条消息..,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">8s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">]条消息......,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">4s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">]条消息.....,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">5s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">]条消息....,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">6s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">9</span><span style="color:#C3E88D;">]条消息.........,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">8</span><span style="color:#C3E88D;">]条消息........,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">2s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">7</span><span style="color:#C3E88D;">]条消息.......,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">3s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">10</span><span style="color:#C3E88D;">]条消息..........,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"></span></code></pre></div><blockquote><p>可以看到上面的打印，消息是轮训发放的，就算要等很久才能消费，也会按轮训的顺序分配</p><p>序号【<code>NO1</code>】消费第<code>3、6、9</code>条消息</p><p>序号【<code>NO2</code>】消费第<code>2、5、8</code>条消息</p><p>序号【<code>NO3</code>】消费第<code>1、4、7、10</code>条消息</p></blockquote><blockquote><p>但是其实<code>第4条</code>消息<code>【NO1】</code>来消费是比较合适的，因为它等待的时间最短，可以更早地去处理下一条消息</p><p>要想达到这样的效果，可以通过<code>ch.Qos</code>方法，将<code>prefetch</code>设置为<code>1</code>，它表示在消费者确认消息之前，<code>RabbitMQ</code>可以<code>发送给消费者的最大消息数</code>，也就是告诉<code>RabbutMQ</code>一次不要给一个工作者多于<code>1条</code>消息，这通常用于确保消费者逐条处理消息，避免消息堆积。</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Qos</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">// prefetch count</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">// prefetch size</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// global</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ul><li><code>prefetchCount(int)</code>:</li></ul><blockquote><p>解释: 预取计数（Prefetch Count）定义了在消费者确认消息之前，RabbitMQ 可以发送给消费者的最大消息数。简单来说，就是<code>消费者在确认之前最多可以收到多少条消息</code>。</p></blockquote><blockquote><p>示例中的值: 1 表示消费者在确认一条消息之前最多只能收到一条消息。这通常用于确保消费者逐条处理消息，避免消息堆积。</p></blockquote><ul><li><code>prefetchSize(int)</code>:</li></ul><blockquote><p>解释: 预取大小(Prefetch Size)定义了在消费者确认消息之前，RabbitMQ可以发送给消费者的最大字节数。通常情况下，这个值设置为<code>0</code>，表示<code>不限制大小</code>。</p></blockquote><blockquote><p>示例中的值: 0 表示没有预取大小的限制。</p></blockquote><ul><li><code>global(bool)</code>:</li></ul><blockquote><p>解释: 全局标志(Global Flag)决定了<code>QoS</code>设置是应用于整个通道还是仅应用于当前消费者。</p></blockquote><blockquote><p>示例中的值: <code>false</code>表示<code>QoS</code>设置仅应用于<code>当前消费者</code></p></blockquote><blockquote><p>如果设置为<code>true</code>，则QoS设置应用于<code>整个channel上所有的消费者</code></p></blockquote><blockquote><p>调整后输出如下：</p></blockquote><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">]条消息...,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">7s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">]条消息.,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">9s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">]条消息..,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">8s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">]条消息....,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">6s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">]条消息.....,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">5s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">]条消息......,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">4s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">8</span><span style="color:#C3E88D;">]条消息........,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">2s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">7</span><span style="color:#C3E88D;">]条消息.......,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">3s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">9</span><span style="color:#C3E88D;">]条消息.........,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Received</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">message:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">我是第[</span><span style="color:#F78C6C;">10</span><span style="color:#C3E88D;">]条消息..........,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Will</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"><span style="color:#FFCB6B;">【NO</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">】Done</span></span>
<span class="line"></span></code></pre></div><blockquote><p>如上：【NO2】先消费第<code>3</code>条消息，如果没有上面的设置那么它完成后会先去消费第<code>6</code>条消息，但是通过<code>Qos</code>方法设置后，先消费第<code>4</code>条消息</p></blockquote><h2 id="消息确认" tabindex="-1">消息确认 <a class="header-anchor" href="#消息确认" aria-hidden="true">#</a></h2><blockquote><p>现在这个场景下，如果我们启动<code>worker.go</code>后，然后启动<code>task.go</code>，此时消息如果还没有接收完，就断开<code>worker.go</code>，那么此时刚才未处理的消息就会消失，再次 执行<code>worker.go</code>也不会接收到任何消息了</p></blockquote><div class="tip custom-block"><p class="custom-block-title">TIP</p><ul><li>上面的现象是因为在调用<code>ch.Consume</code>函数时，将<code>第3个参数auto-ack</code>设置为了<code>true</code>，这表明只要<code>Producer</code>成功发送消息后，就将该消息标记为<code>已确认</code>，默认该消息已经完成处理，不会管<code>Consumer</code>是否收到</li></ul></div><blockquote><p>要处理上面的问题，需要以下步骤</p><p>1、将<code>auto-ack</code>设置为<code>false</code></p><p>2、消息处理完成后手动调用<code>Ack</code>函数确认已收到消息</p></blockquote><blockquote><p><code>worker.go</code>修改如下：</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">consumeMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Channel</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> queueName </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serialNumber </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// 4、consume message</span></span>
<span class="line"><span style="color:#A6ACCD;">	message</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Consume</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">		queueName</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// consumer</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// auto-ack 不自动确认消息</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// no-local</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// args</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	shared</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FailOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">consume queue message error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">range</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			dotCount </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> bytes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Count</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Body</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">			duration </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Duration</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> dotCount</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">【NO %d】 Received a message: %s, Will wait [%s]</span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serialNumber</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Body</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Second</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sleep</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">duration </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> time</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Second</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Done </span><span style="color:#A6ACCD;">\\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#676E95;font-style:italic;">// Manually confirm that the message has been delivered</span></span>
<span class="line"><span style="color:#A6ACCD;">			msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Ack</span><span style="color:#89DDFF;">(false)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="消息持久化" tabindex="-1">消息持久化 <a class="header-anchor" href="#消息持久化" aria-hidden="true">#</a></h2><blockquote><p>现在的代码中，如果在<code>发送/接收</code>消息的过程中，<code>RabbitMQ</code>服务挂了，或者<code>出错退出了</code>，那么消息就会丢失</p><p>为了解决这个问题，可以设置<code>消息持久化</code>，对于<code>Producer</code>和<code>Consumer</code>都要设置</p></blockquote><blockquote><p>1、发送方</p><ul><li>调用<code>ch.PublishWithContext</code>函数时，设置<code>消息body(amqp.Publishing)</code>时，将模式<code>DeliveryMode</code>改为持久化</li><li>声明队列调用<code>ch.QueueDeclare</code>函数时，将第二个参数<code>durable</code>设置为<code>true</code></li></ul></blockquote><blockquote><p><code>task.go</code>修改如下：</p></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 3. declare a queue，it will only be created if it doesn&#39;t exist already</span></span>
<span class="line"><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">second_queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">//delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">//exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PublishWithContext</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    withTimeoutCtx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//exchange name</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// routing key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">// mandatory</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">//immediate</span></span>
<span class="line"><span style="color:#A6ACCD;">    amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Publishing</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        DeliveryMode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amqp</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Persistent</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// DeliveryMode  uint8  // Transient (0 or 1) or Persistent (2)</span></span>
<span class="line"><span style="color:#A6ACCD;">        Body</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">[]</span><span style="color:#82AAFF;">byte</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">messageBody</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        ContentType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p>2、接收方</p><ul><li>声明队列调用<code>ch.QueueDeclare</code>函数时，将第二个参数<code>durable</code>设置为<code>true</code></li></ul></blockquote><div class="language-Go"><button title="Copy Code" class="copy"></button><span class="lang">Go</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 3. declare a queue，it will only be created if it doesn&#39;t exist already</span></span>
<span class="line"><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> ch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">QueueDeclare</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">second_queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// queue name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;">// durable</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">//delete when unused</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">//exclusive</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// no-wait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">nil,</span><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;">// arguments</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div>`,38),e=[p];function t(c,r,C,D,y,A){return a(),n("div",null,e)}const d=s(o,[["render",t]]);export{i as __pageData,d as default};
